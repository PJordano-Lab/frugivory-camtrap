---
title: "Doñana_frugyvory_camptrap"
author: "PVA"
date: "6/7/2023"
output: html_document
---
The following scripts compile several datasets for Doñana-camtrap-frugivory data paper.

We merge and standardise data from different surveys of Ecological Interactions in Doñana. Those areSumhal yr1/yr2 & Corema_1 & Juniperus phoenicea (Islas phD thesis) & Pistacia lentiscus (Quinteros phD thesis).

Here we integrate (merge) all the datasets into one final df while we correct some inconsistencies and introduce coordinates & sampling effort at species and individual level.

Libraries
```{r}
library(dplyr)
library(stringr)
library(lubridate)
```
#CALCULATE SAMPLING EFFORT


# DATA MERGING
## 1 Load data 
  We read from csv the datasets generated in the "data unification" script above to skip running the entire code again.
```{r }
#2,943 rows
sumhal_yr1 <- read.csv2 ("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/sumhal_yr1.csv", sep = ";") 

#5,304 rows
sumhal_yr2 <-  read.csv2 ("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/sumhal_yr2.csv", sep = ";")

#79 rows
joxy_yr2 <- read.csv2 ("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/sumhal_joxy_yr2.csv", sep = ";") 

#274 rows
sumhal_indet <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/sumhal_indet_yr1_yr2.csv", sep = ";") 

#420 rows
corema_1 <-  read.csv ("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/sumhal_corema_1.csv", sep =";")  
 
# 1,164 rows
plen <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/plen_adapted.csv") 

# 811 rows
jpho <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/jpho_adapted.csv") 
```

## 2 Integrate SUMHAL_YR1 & Yr2 & Joxy_Yr2                - 8,326 rows
  Here we filter/select data & correct plant names for consistency & merge sumhal Yr1 & Yr2 & joxy_Yr2 into a SUMHAL df
```{r }
s_yr1 <- sumhal_yr1 %>%
  filter(Plant != "pinus" ) %>%   #Eliminate Pinus from the db (it is not fleshy fruit)
  select(Sp1, Plant, Plant_ID, Revision_ID, Dt_correct, Behaviour, Count, Coexistence, n_cam, Days, Days.in.field, duration, ID, long, lat) %>%
  mutate(Plant = if_else( Plant == "pyrus"      , "pbou" , Plant), #Change plant names for consistency
        Plant = if_else ( Plant == "corema_2"   , "calb" , Plant),
        Plant = if_else ( Plant == "asparagus"  , "aspa" , Plant),
        Plant = if_else ( Plant == "rubus"      , "rulm" , Plant),
        Plant = if_else ( Plant == "olea"       , "oeur" , Plant),
        Plant = if_else ( Plant == "rubia"      , "rper" , Plant),
        Plant = if_else ( Plant == "arbutus"    , "aune" , Plant),
        Plant = if_else ( Plant == "smilax"     , "sasp" , Plant),
        Plant = if_else ( Plant == "myrtus"     , "mcom" , Plant),
        Plant_ID = ifelse(Plant == "calb", str_replace(Plant_ID, "a", "calb"), Plant_ID), #Change PlantID names for Corema
        Plant_ID = ifelse(Plant_ID == "pbou121", str_replace(Plant_ID, "pbou121", "pbou012"), Plant_ID), #Change incorrect name for a pyrus individuals
        Dt_correct = as.POSIXct(Dt_correct)) %>%
        rename(DateTime = Dt_correct)
        
s_yr2 <- sumhal_yr2 %>%
  mutate(Dt_correct = as.POSIXct(Dt_correct),
         Plant_ID = ifelse(Plant_ID == "Oeur20_", str_replace(Plant_ID, "Oeur20_", "Oeur020"), Plant_ID), #Change incorrect name for a Olea individual)
         ID = str_c(Plant_ID, Revision, File, sep = "_")) %>% 
  select(Sp1, Plant, Plant_ID, Revision, Dt_correct, Behaviour, Count, Coexistence, n_cam, Days, Days.in.field, Duration, ID, long, lat) %>%
  rename(DateTime = Dt_correct, duration = Duration, Revision_ID = Revision) %>%
  mutate(Plant_ID = str_to_lower(Plant_ID))
  


j_yr2 <- joxy_yr2 %>%
  mutate(ID = str_c(Plant_ID, Revision_ID, File, sep = "_")) %>%
  select(Sp1, Plant, Plant_ID, Revision_ID, Dt_correct , Behaviour, Count, Coexistence, n_cam, Days, Days.in.field, duration, ID, long, lat) %>%
  mutate(Plant_ID = str_to_lower(Plant_ID),
         Dt_correct = as.POSIXct(Dt_correct)) %>%
  rename(DateTime = Dt_correct)

sumhal <- rbind(s_yr1, s_yr2, j_yr2)   #Here Sumhal data are consistent and joined in one df

```

## 3 Integrate COREMA_1                                   - 420 rows   == 8,746  rows

```{r }
cor_1 <- corema_1 %>%
  mutate(Plant = "calb",
        Coexistence = FALSE,
        ID = str_sub(ID, start = 1L, end = 12),
        DateTime = as.POSIXct(DateTime)) %>%
  select(Sp1, Plant, Plant_ID, Revision_ID, DateTime, Behaviour, Count, Coexistence, n_cam, Days, Days.in.field, duration, ID, lat, long)

  
#Join SUMHAL (8,326 row) df to COREMA_1 (721 rows) DF == 9047 rows 
data1 <- rbind(sumhal, cor_1)
```

## 4 Integrate PISTACIA LENTISCUS                         - 1,164 rows == 9,910  rows
```{r }
plen2 <- plen %>%
  mutate(Days.in.field = NA,
         ID = NA,
         Revision_ID = NA,
         Coexistence = FALSE,
         DateTime = as.POSIXct(DateTime),
         plant_ID = str_to_lower(plant_ID)) %>%
  select(plant, plant_ID, Revision_ID, DateTime, Sp1, behaviour, Count, ncam, Days, Days.in.field, duration, ID, Lat, Long, Coexistence ) %>%
  rename(Plant = plant, Plant_ID = plant_ID, Behaviour = behaviour, n_cam = ncam, lat = Lat, long = Long)


data2 <- rbind(data1, plen2)
```

## 5 Integrate JUNIPERUS PHOENICEA                        - 810 rows   == 10,720 rows
```{r }
jpho_2 <- jpho %>%
  select(-X, Plant) %>%
  mutate(Plant = "jpho", #Change plant name
         Plant_ID = str_replace_all(Plant_ID, "C065", "C066"), #change 5 PlantID names wich number was repeated in different populations - showinh problems in coordinate merging
         Plant_ID = str_replace_all(Plant_ID, "C176", "C177"),
         Plant_ID = str_replace_all(Plant_ID, "C054", "C044"),
         Plant_ID = str_replace_all(Plant_ID, "M136", "M138"),
         Plant_ID = str_replace_all(Plant_ID, "M304", "M305"),
         Plant_ID = str_replace_all(Plant_ID, "C", "jpho"), #Change plantID base name for consistency with the rest of the dataset
         Plant_ID = str_replace_all(Plant_ID, "M", "jpho"),
         Plant_ID = str_replace_all(Plant_ID, "O", "jpho"),
         Sp1 = str_replace_all(Sp1, "rodent", "apode-mus"),
         Revision_ID = NA,
         DateTime = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M:%S")) %>%
  filter(!is.na(DateTime)) 
  

data3 <- rbind(data2, jpho_2)

```

## 6 Integrate INDETERMINED VIDEOS                        - 274 rows   == 10,994 rows
  Here we integrate videos that were we had doubts on the species determination and were determined later in the process (for Sumhal yr1 and yr2)
```{r }
#data3 to data4
sumhal_ind <- sumhal_indet %>%
  mutate(Plant = str_to_lower(Plant),
         DateTime = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M:%S")) %>%
  rename(lat = Lat , long = Long) %>%
  select(Behaviour, Count, Coexistence, DateTime, Days, Days.in.field, duration, ID, lat, long, n_cam, Plant, Plant_ID, Revision_ID, Sp1)

data4 <- rbind(data3, sumhal_ind)

```

## 7 Include SAMPLING EFFORT by plant species and induvidual            - 10,994 rows 
  Here we create new columns with sampling effort by Plant and plant_ID (from a different script called Sampling effort) - data5 has both merged efforts
```{r }
effort_species <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/Sampling_effort/effort_species.csv") %>%
  mutate(Plant = str_to_lower(Plant))%>%
  select(-X)

effort_individual <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/Sampling_effort/effort_individual_level.csv") %>%
  mutate(Plant_ID = str_to_lower(Plant_ID))%>%
  select(-X)

#Join effort by plant species 
data4_eff_sp <- left_join(data4, effort_species, by = "Plant", keep = FALSE)

#Join effort by plant individuals (data 5 has both efforts merged)
data5 <- left_join(data4_eff_sp, effort_individual, by = "Plant_ID", keep = FALSE)

```

## 8 Include COORDINATES                                                - 10,994 rows
  Here we join new coordinates to the df because there were some inconsistencies in format. 
```{r }
  coord_13sp <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/Coordinates/coordinates_13_spp.csv") 

data6 <- left_join(data5, coord_13sp, by = "Plant_ID", keep = F) %>%
  select(-long, -lat, -X)
```

## 9 Create the FINAL DF                                                - 10,714 rows
  Here we check and correct mistaken names for Sp1 & Plant_ID & create new column with mammal/bird
```{r }
#Correct mistaken names
data6$Sp1 [data6$Sp1 == "chloris cloris" ] <- "chloris chloris" 
data6$Sp1 [data6$Sp1 == "cyanistes caerulius" ] <- "cyanistes caeruleus" 
data6$Sp1 [data6$Sp1 == "cyanopica cyanus" ] <- "cyanopica cooki" 
data6$Sp1 [data6$Sp1 == "fringilia coelebs" ] <- "fringilla coelebs" 
data6$Sp1 [data6$Sp1 == "lanius excubitor" ] <- "lanius meridionalis" 
data6$Sp1 [data6$Sp1 == "orictolagus cuniculus" ] <- "oryctolagus cuniculus" 
data6$Sp1 [data6$Sp1 == "rodent rodent" ] <- "rodent" 
data6$Sp1 [data6$Sp1 == "sylvia sp." ] <- "sylvia sp" 
data6$Sp1 [data6$Sp1 == "unknown unknown" ] <- "unknown" 
data6$Sp1 [data6$Sp1 == "unkown" ] <- "unknown" 
data6$Sp1 [data6$Sp1 == "x" ] <- "unknown" 
data6$Sp1 [data6$Sp1 == "?" ] <- "unknown"
data6$Sp1 [data6$Sp1 == "apode-mus apode-mus" ] <- "apode-mus" 
data6$Sp1 [data6$Sp1 == "hippolais polyglotta" ] <- "hippolais poliglotta"
data6$Sp1 [data6$Sp1 == "emberiza schoeniclus" ] <- "emberiza schoeniculus"
data6$Sp1 [data6$Sp1 == "sylvia undatac" ] <- "sylvia undata"
data6$Plant_ID [data6$Plant_ID == "a03" ] <- "calb03" 
data6$Plant_ID [data6$Plant_ID == "a07" ] <- "calb07" 
data6$Plant_ID [data6$Plant_ID == "a10" ] <- "calb10" 
data6$Plant_ID [data6$Plant_ID == "oeur20_" ] <- "oeur020" 


#Create a final dataframe filtering non interesting species and column Mamal/bird and correct Timestamp Issues (change those asparagus that have events  pm to am)
data7 <- data6 %>%
  filter (Sp1 != "unknown", 
          Sp1 != "athene noctua") %>%
  mutate(SpeciesType = ifelse(grepl("bos|equus|cervus|sus|meles|vulpes|dama|apode-mus|oryctolagus|genetta|herpestes|lepus|rattus", data7$Sp1, ignore.case = TRUE), "Mammal", "Bird"),
         DateTime = case_when(SpeciesType == "Bird" & hour(DateTime) >= 21 & hour(DateTime) <= 23 ~ DateTime + hours(12), TRUE ~ DateTime),
         DateTime = case_when(SpeciesType == "Bird" & hour(DateTime) >= 0 & hour(DateTime) <= 6 ~ DateTime + hours(12), TRUE ~ DateTime)) %>% #Change all bird species that are eating during the night 12 hours (because those cases seem to be a am-pm issue)
  filter(DateTime != is.na(DateTime))

```

## 10 FIX remaining Timestamp Isuues                                    - 10,714 rows
   Cannot trace some of the files.
```{r }
data8  <- data7 %>%
        mutate (ID = ifelse(Plant == "plen", Plant_ID, ID),  #ID for Plen (if empty it removes dates)
                Dt_correct = format(DateTime, "%Y-%m-%d %H:%M:%S"),
                Dt_correct = ifelse (ID == "pbou004_rev01_01010002"                   , "2021-10-14 03:38:40", Dt_correct),
                Dt_correct = ifelse (ID == "a12_rev01_01020004"                       , "2021-08-03 12:53:14", Dt_correct),
                Dt_correct = ifelse (ID == "pbou004_rev01_01120724"                   , "2021-10-15 02:46:10", Dt_correct),
                Dt_correct = ifelse (ID == "pbou004_rev01_01130048"                   , "2021-10-16 18:16:06", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_01270037"                   , "2021-10-14 19:02:58", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_02240008"                   , "2021-10-14 08:26:16", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_02240018"                   , "2021-10-17 15:28:00", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_02240023"                   , "2021-10-18 15:37:10", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_02260075"                   , "2021-10-20 07:45:04", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_02260094"                   , "2021-10-20 20:15:44", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_03060714"                   , "2021-11-01 20:39:14", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_03090254"                   , "2021-11-03 05:53:26", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_03090256"                   , "2021-11-03 06:21:42", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_03110151"                   , "2021-11-05 04:19:48", Dt_correct),
                Dt_correct = ifelse (ID == "pbou002_rev01_03110158"                   , "2021-11-05 04:53:30", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0007"                   , "2021-12-01 07:29:10", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0008"                   , "2021-12-01 07:37:54", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0012"                   , "2021-12-01 12:57:08", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0013"                   , "2021-12-01 13:46:17", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0014"                   , "2021-12-01 18:51:38", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0020"                   , "2021-12-02 11:11:40", Dt_correct),
                Dt_correct = ifelse (ID == "a10_rev01_IMG_0002"                       , "2021-08-03 11:11:40", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0025"                   , "2021-12-01 13:32:38", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0027"                   , "2021-12-02 10:48:04", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0029"                   , "2021-12-03 14:54:38", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0032"                   , "2021-12-03 16:02:26", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0033"                   , "2021-12-04 07:23:56", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0035"                   , "2021-12-04 07:51:38", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0038"                   , "2021-12-04 17:34:06", Dt_correct),
                Dt_correct = ifelse (ID == "aspa003_rev01_IMG_0045"                   , "2021-12-05 14:55:32", Dt_correct),
                Dt_correct = ifelse (ID == "Joxy023_Rev09_IMG_0018.MP4, IMG_0019.MP4" , "2023-01-13 07:49:04", Dt_correct),
                Dt_correct = ifelse (ID == "Joxy023_Rev09_IMG_0042.MP4"               , "2023-01-19 00:02:26", Dt_correct),
                Dt_correct = ifelse (ID == "Joxy023_Rev09_IMG_0052.MP4"               , "2023-01-21 08:14:18", Dt_correct))%>%
                select(-c(DateTime)) %>%
                rename(DateTime = Dt_correct) %>%
                mutate(DateTime = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M:%S"))
 
```

## 11 Give final format to database for publication
```{r }
# -------  Give a Revision number for "plen" 
#Filter only Pistacia lentiscus
pistacia <- data8 %>%
  filter(Plant == "plen") %>%
  mutate(Revision_ID = pistacia_rev) #Run the code below to create pistacia revision

#Create a revision number based on each visit to the field (based on the day from DateTime column) 
date_string <- format(pistacia$DateTime, "%Y-%m-%d")
revision_number <- match(date_string, unique(date_string))
pistacia_rev <- paste("Rev", revision_number, sep = "")

#Remove plen from data8 and join it again with the new revision column.
data9 <- data8 %>%
  filter(Plant != "plen") %>%
  bind_rows(pistacia)

# ---------  Add a 0 to all Corema Plant_IDs for consistency with the rest of species "Calb001" instead of "Calb01"
data10 <- data9 %>%
  mutate(Plant_ID = str_replace_all(Plant_ID, "calb", "calb0"),
         Revision_ID = str_to_sentence(Revision_ID))

# --------  Change Plant species acronyms for the entire scientific name and change colnames
data11 <- data10 %>%
  mutate(Plant = str_replace_all(Plant, "aspa" , "Asparagus aphyllus"),
         Plant = str_replace_all(Plant, "aune" , "Arbutus unedo"),
         Plant = str_replace_all(Plant, "calb" , "Corema album"),
         Plant = str_replace_all(Plant, "joxy" , "Juniperus oxycedrus"),
         Plant = str_replace_all(Plant, "jpho" , "Juniperus phoenicea"),
         Plant = str_replace_all(Plant, "mcom" , "Myrtus communis"),
         Plant = str_replace_all(Plant, "oeur" , "Olea europaea"),
         Plant = str_replace_all(Plant, "olan" , "Osyris lanceolata"),
         Plant = str_replace_all(Plant, "pbou" , "Pyrus bourgeana"),
         Plant = str_replace_all(Plant, "plen" , "Pistacia lentiscus"),
         Plant = str_replace_all(Plant, "rper" , "Rubia peregrina"),
         Plant = str_replace_all(Plant, "rulm" , "Rubus ulmifolius"),
         Plant = str_replace_all(Plant, "sasp" , "Smilax aspera"),
         Sp1 = str_to_sentence(Sp1),
         Sp1 = str_replace_all(Sp1, "Rattus", "Rattus rattus")) %>%
    rename(AnimalSpecies = Sp1, PlantSpecies = Plant, PlantID = Plant_ID, RevisionID = Revision_ID, NCam = n_cam, EffortRev = Days, Duration = duration, EffortSpecies = effort_pl_sp, EffortInd = effort_ind, Longitude = Long, Latitude = Lat) %>%
  select(-c(Days.in.field, ID))

# -------- Rule for Behavior (If there are more than one behaviors in a collapsed observation we choose the most frugivor related one i.e eating > prob. eating > searching for food)
#a - eating
#b - probably eating
#c - searching for food

data12 <- data11 %>%
  mutate(Behav = Behaviour,
         Behav = str_replace_all(Behav, "feeding", "eating"),
         Behav = str_replace_all(Behav, "probably eating", "b"),
         Behav = str_replace_all(Behav, "prob_eating", "b"),
         Behav = str_replace_all(Behav, "eating", "a"),
         Behav = str_replace_all(Behav, "searching for food", "c"),
         Behav = ifelse(grepl("a",Behav), "eating",Behav),
         Behav = ifelse(grepl("b",Behav), "probably eating",Behav),
         Behav = ifelse(grepl("c",Behav), "searching for food",Behav)) %>%
  select(-Behaviour) %>%
  rename(Behaviour = Behav)

# -------- Unify decimal numbers for each column
data13 <- data12 %>%
  mutate(Duration = round(as.numeric(Duration), 1),
         EffortRev = round(as.numeric(EffortRev), 2),
         EffortInd = round(as.numeric(EffortInd), 2), 
         EffortSpecies = round(as.numeric(EffortSpecies), 2))

# -------- Fix Revision number format (add a 0 if the RevisionID mathces the pattern "Rev" followed by a single digit)
data14 <- data13 %>%
  mutate(RevisionID = case_when(
    grepl("^Rev\\d$", RevisionID) ~ paste0("Rev0", substr(RevisionID, start = 4, stop = nchar(RevisionID))),
    TRUE ~ RevisionID)) 

# -------- Change names from Gr. Sylvia maintaining S.atricapilla and S.borin
data15 <- data14 %>%
  mutate(AnimalSpecies = str_replace_all(AnimalSpecies, "Sylvia", "Curruca"),
         AnimalSpecies = str_replace_all(AnimalSpecies, "Curruca atricapilla", "Sylvia atricapilla"),
         AnimalSpecies = str_replace_all(AnimalSpecies, "Curruca borin", "Sylvia borin"))

#write.csv(data15, "/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Dataset_2023_07_19/DataS1_corrected_sylvia.csv")

```



