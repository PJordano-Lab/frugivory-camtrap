---
title: "Do√±ana_frugyvory_camptrap"
author: "PVA"
date: "6/7/2023"
output: html_document
---
The following script is an example of the workflow needed to compile the information from camera traps for ecological interactions in the data-paper Frugivory-camtrap. Note that this example only uses data from the species Arbutus unedo during the second fruiting season monitored (2022-2023). The input file is a .csv that have been visualized and tagged in the TimeLapse visualization program (Greenberg ####) after a Megadetector (AI) run to remove blank videos.   

Libraries
```{r}
library(dplyr)
library(stringr)
library(lubridate)
```
# 1. SAMPLING EFFORT 
## 1. Read the data with sampling efforts from camera trap survey
```{r }
#Sampling effort data for Arbutus unedo (second fruiting season)
sampling_effort <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Code/data_example_raw_data/sampling_effort.csv")
```

## 2. GROUP effort for plant species level and for individual plant level 
```{r }
#Species level
eff_sp_level <- sum(sampling_effort$num_days)

#Individual level  
eff_ind_level <- sampling_effort %>%
   group_by(Plant_ID) %>%
   summarise(effort_ind = sum(num_days))

#Revision level (and TimestampIssues)
eff_rev <- data.frame(sampling_effort %>%
  group_by (Plant_ID, rev) %>%
  summarise(effort_rev = sum(num_days),
            n_cam = n(), 
            ID = str_c(Plant_ID, rev, sep="_" ))) %>% 
  select(ID, n_cam, effort_rev)
```


# DATA MERGING
## 0. Prepare toy dataset
```{r }
#Prepare Aune data
Aune_data <-  read.csv2 ("/Users/Pablo/Documents/GitHub/Animal-detection-cameratrap/Results/Timelapse results Yr2/Arbutus_yr2_revised_c01.csv", sep = ",") 
  
splited_path <- data.frame(str_split_fixed(Aune_data$RelativePath, "\\\\", 4))%>%
  rename(Folder = X1, Plant = X2, Revision = X3, Deployment = X4) %>%
  mutate(Revision = str_remove_all(Revision, "Aune_"),
         Revision = str_sub(Revision, start = 1, end = 5))

Revision <- data.frame(splited_path$Revision) %>%
  rename(Revision = splited_path.Revision)

Deployment_ID <- data.frame(splited_path$Deployment)%>%
  rename(Deployment_ID = splited_path.Deployment)

Plant_ID <- data.frame(str_sub(splited_path$Deployment, start=1, end = 7)) %>%
  rename(Plant_ID = str_sub.splited_path.Deployment..start...1..end...7.)

Aune_data2 <- Aune_data %>%
  mutate(Path = str_c(RelativePath, File, sep = "/"),
         Path = str_replace_all(Path, "\\\\", "/"),
         Path = str_remove_all(Path, "SUMHAL_YR2/Arbutus/Aune_"))%>%
  cbind(Revision, Deployment_ID, Plant_ID)

#change counts
Aune_data2$Count1 <- ifelse(Aune_data2$Sp1 != "", 1, Aune_data2$Count1)
Aune_data2$Count2 <- ifelse(Aune_data2$Sp2 != "", 1, Aune_data2$Count2)

#Select columns
Aune_data3 <- Aune_data2 %>%
  select(File, Path, Plant_ID, Revision, DateTime, Behaviour, Sp1, Count1, Sp2, Count2, Behaviour2, Deployment_ID)

write.csv(Aune_data3, "/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Code/data_example_raw_data/example_dataset.csv")

#----------------------------------------------------------

#Prepare file info 
file_info <- read.csv2 ("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/File_info_HD/file_info.csv", sep=",") %>%
  filter(grepl("Aune", Path)) %>%
  select(Path, duration) %>%
  mutate(Path = str_remove_all(Path, "/Volumes/G-RAID/SUMHAL/Arbutus/"),
         Path = str_remove_all(Path, "/Volumes/G-RAID-3/SUMHAL_YR2/Arbutus/Aune_"))

write.csv(file_info, "/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Code/data_example_raw_data/example_file_info.csv")

colnames(Aune_data2)
```

## 1. Load video level data - The data is the output after the visualization with TimeLapse.
```{r }
Aune_data <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/raw_data/toy_dataset.csv")
```

## 2. Include video duration 
```{r }
#Summary list of file metadata extracted from Hard drive files
file_info <- read.csv2 ("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/File_info_HD/toy_file_info.csv", sep=",")

#join data and file list
Aune_dat <- Aune_data %>%
  left_join(file_info, by = "Path")
```

## 3. Include sampling effort 
```{r }
Aune_dat_effort <- Aune_dat %>%
  mutate(ID = str_c(Plant_ID, Revision, sep = "_"),
         effort_sp_level = eff_sp_level) %>%
  left_join(eff_ind_level, by = "Plant_ID") %>%
  left_join(eff_rev, by = "ID") %>%
  distinct()
```

## 4. Include coordinates 
```{r }
coord <- read.csv("/Users/Pablo/Documents/GitHub/donana-frugivory-camtrap/Metadata/Coordinates/coordinates_13_spp.csv") %>%
  filter(grepl("aune", Plant_ID)) %>%
  mutate(Plant_ID = str_to_sentence(Plant_ID))
  
Aune_dat_coord <- Aune_dat_effort %>%
  left_join(coord, by = "Plant_ID")
```

## 5. Filter eating behaviours - 2,662 rows 
```{r }
Aune_eating <- Aune_dat_coord %>%
  filter(Behaviour == "eating"| Behaviour == "probably eating" | Behaviour == "searching for food")
```

## 6. Split entries with two species.
We will duplicate the entries where there are two species (SP2 = "non empty") and rename Sp1 with Sp2 name. The rest of the columns will maintain invariable (traceable through Plant_ID/Rev/File). A new column "Coexistence" will be created for searching events with more than one species.
```{r }
# Rows with only one species  - 2,576 row
rows_wo_sp2 <- Aune_eating %>%
 filter(is.na(Sp2) | nchar(Sp2) == 0) %>%
  mutate(Coexistence = FALSE)

# Rows with two species: change Sp2 to Sp1 - 62 rows (Duplicate rows based on Sp2 and Behaviour2 conditions) 
new_rows_for_sp2 <- Aune_eating %>%
  filter(!is.na(Sp2) & nchar(Sp2) > 0 & Behaviour2 %in% c("eating", "probably eating", "searching for food")) %>%
  mutate(Sp1 = Sp2,
         Count1 = Count2,
         Behaviour = Behaviour2,
         Coexistence = TRUE)

# Combine the original data with the duplicated rows should be 2,638 rows
Aune_split <- bind_rows(rows_wo_sp2 , new_rows_for_sp2) %>%
  select(!c (Sp2, Count2, Behaviour2)) 
```

## 7. Remove unknown species and correct inconsitencies
```{r}
#Remove unknown species and correct some inconsistent names for Sp1
df1 <- Aune_split %>%
  filter( Sp1 != "?", 
          Sp1 != "") %>%
  mutate( Sp1 = str_to_sentence(Sp1))

#Rectify inconsistent names resulting from manual typing during the visualization process.  
df1$Sp1 [df1$Sp1 == "Fr" ] <- "Fringilla coelebs"
df1$Sp1 [df1$Sp1 == "Turdus me" ] <- "Turdus merula"
df1$Sp1 [df1$Sp1 == "Sylvia melanocephala" ] <- "Curruca melanocephala"
```

#8. Collapse videos into 5 min events
```{r}
Aune_collapsed <- df1 %>%
  group_by(Plant_ID, Revision) %>%
  mutate(interval = as.POSIXct(round(as.numeric(as.POSIXct(DateTime)) / (60*5)) * (60*5), origin="1970-01-01")) %>%
  group_by(interval, Sp1) %>%
  summarize( 
    n = n(),
    PlantSp = "Arbutus unedo",
    Plant_ID = first(Plant_ID),
    File = paste(File, collapse=', '),
    Count = max(Count1),
    DateTime = first(as.POSIXct(DateTime)),
    Behaviour = paste(Behaviour, collapse=', '),
    Coexistence = first(Coexistence),
    N_cam = first(n_cam),
    EffortRev = first(effort_rev),
    EffortSpecies = first(effort_sp_level),
    EffortInd = first(effort_ind),
    duration = sum(as.numeric(duration)),
    long = first(Long),
    lat = first(Lat),
    Revision_ID = first(Revision),
    Deployment_ID = first(Deployment_ID),
    ID = first(ID),
    TimestampIssue = first(TI)
                              ) %>%
  rename(AnimalSpecies = Sp1) %>%
  data.frame()
```

## 8. Fix Timestamp Issues ????
```{r }
TI_to_fix <- Aune_collapsed %>%
  filter(TimestampIssue == TRUE)

unique(TI_to_fix$Deployment_ID) #Deployments with TI in our collapsed data


#File info (need to introduce first and last dates for each revision/deployment)
Aune_info <- file_info %>%
  filter(grepl("Aune", Path))

split <- data.frame(str_split_fixed(Aune_info$Path, "/", 8)) %>%
  rename(Revision = X6, Deployment_ID = X7, File = X8) %>%
  mutate(Revision = str_sub(Revision, start = 1, end = 4),
         file_num = str_sub(File, start=5, end = 8)) %>%
  select(Revision, Deployment_ID, File, file_num)

file_info2 <- cbind(Aune_info, split$Revision, split$Deployment_ID, split$File, split$file_num)


# Create first and last file date columns
first_last_dates <- file_info2 %>%
  group_by(split$Revision, split$Deployment_ID) %>%
  summarize(
    FirstDate = as.POSIXct(min(as.POSIXct(filemodifydate, format = "%Y:%m:%d %H:%M:%S"))),
    LastDate = as.POSIXct(max(as.POSIXct(filemodifydate, format = "%Y:%m:%d %H:%M:%S")))
  )

# Add the extracted dates back to the original data frame
file_info3 <- left_join(file_info2, first_last_dates, by = c("split$Revision", "split$Deployment_ID"))


Aune_collapsed
```

## 9. Give final format to database for publication
```{r }
# -Rule for Behavior (If there are more than one behaviors in a collapsed observation we choose the most frugivore related one i.e eating > prob. eating > searching for food)
#a - eating
#b - probably eating
#c - searching for food

df2 <- Aune_collapsed %>%
  mutate(Behav = Behaviour,
         Behav = str_replace_all(Behav, "probably eating", "b"),
         Behav = str_replace_all(Behav, "eating", "a"),
         Behav = str_replace_all(Behav, "searching for food", "c"),
         Behav = ifelse(grepl("a",Behav), "eating",Behav),
         Behav = ifelse(grepl("b",Behav), "probably eating",Behav),
         Behav = ifelse(grepl("c",Behav), "searching for food",Behav)) %>%
  select(-Behaviour) %>%
  rename(Behaviour = Behav)

# -------- Unify decimal numbers for each column
df3 <- df2 %>%
  mutate(duration = round(as.numeric(duration), 1),
         EffortRev = round(as.numeric(EffortRev), 2),
         EffortInd = round(as.numeric(EffortInd), 2), 
         EffortSpecies = round(as.numeric(EffortSpecies), 2),
         long = round(as.numeric(long), 5),
         lat  = round(as.numeric(lat), 5))

#Create SpeciesType column and Selectcolumns
df4 <- df3 %>%
  mutate(SpeciesType = ifelse(grepl("Cervus|Sus|Meles|Vulpes|Genetta|Herpestes", AnimalSpecies, ignore.case = TRUE), "Mammal", "Bird")) %>%
  select(PlantSp, Plant_ID, AnimalSpecies, DateTime, Behaviour, Coexistence, N_cam, EffortRev, EffortSpecies, EffortInd, duration, long, lat, SpeciesType)

```



